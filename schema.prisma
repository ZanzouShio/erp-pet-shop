// =====================================================
// PRISMA SCHEMA - ERP PET SHOP - PARTE 1/4
// Generator, Datasource e Enums
// =====================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// ENUMS
// =====================================================

enum UserRole {
  admin
  manager
  cashier
  stock
  financial
}

enum CustomerStatus {
  active
  inactive
  defaulter
}

enum PetSize {
  small
  medium
  large
}

enum PetGender {
  male
  female
}

enum SupplierStatus {
  active
  inactive
}

enum StockMovementType {
  IN
  OUT
  ADJUSTMENT
  TRANSFER
  OPENING
  LOSS
}

enum SaleStatus {
  pending
  completed
  cancelled
}

enum InvoiceType {
  nfce
  nfe
  nfse
  sat
  none
}

enum PaymentMethod {
  cash
  debit_card
  credit_card
  pix
  bank_slip
  store_credit
}

enum PixStatus {
  pending
  confirmed
  expired
  cancelled
}

enum QuoteStatus {
  pending
  approved
  rejected
  expired
  converted
}

enum TransactionType {
  revenue
  expense
}

enum TransactionStatus {
  pending
  paid
  partially_paid
  overdue
  cancelled
}

enum AccountType {
  revenue
  expense
  asset
  liability
}

enum BankAccountType {
  checking
  savings
  payment
}

enum ReconciliationStatus {
  pending
  reconciled
  divergent
}

enum InvoiceStatus {
  pending
  authorized
  cancelled
  denied
  contingency
}

enum CertificateType {
  A1
  A3
}

enum CashRegisterStatus {
  open
  closed
}

enum CashMovementType {
  withdrawal
  supply
}

enum LoyaltyTransactionType {
  earn
  redeem
  expire
}

enum StockLocationType {
  store
  warehouse
  other
}

// =====================================================
// PARA CONTINUAR, COPIE A PARTE 2/4
// =====================================================
// =====================================================
// PRISMA SCHEMA - ERP PET SHOP - PARTE 2/4
// Usuários, Clientes, Fornecedores
// COPIE APÓS A PARTE 1
// =====================================================

// =====================================================
// 1. AUTENTICAÇÃO E USUÁRIOS
// =====================================================

model User {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String    @db.VarChar(255)
  email        String    @unique @db.VarChar(255)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  cpf          String?   @unique @db.VarChar(14)
  phone        String?   @db.VarChar(20)
  role         UserRole
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  sessions                  UserSession[]
  auditLogs                 AuditLog[]
  sales                     Sale[]
  quotes                    Quote[]
  cashRegisters             CashRegister[]
  financialTransactions     FinancialTransaction[]
  saleItemsDeletions        SaleItem[]               @relation("DeletedBy")
  cancelledSales            Sale[]                   @relation("CancelledBy")
  stockMovements            StockMovement[]
  cashMovements             CashMovement[]
  bankReconciliations       BankReconciliation[]

  @@map("users")
}

model UserSession {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @db.VarChar(500)
  ipAddress String?  @map("ip_address") @db.VarChar(45)
  userAgent String?  @map("user_agent") @db.Text
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

model AuditLog {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String?  @map("user_id") @db.Uuid
  action      String   @db.VarChar(100)
  entityType  String   @map("entity_type") @db.VarChar(100)
  entityId    String?  @map("entity_id") @db.Uuid
  description String?  @db.Text
  reason      String?  @db.Text
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// =====================================================
// 2. CLIENTES
// =====================================================

model Customer {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name           String         @db.VarChar(255)
  cpfCnpj        String?        @unique @map("cpf_cnpj") @db.VarChar(18)
  email          String?        @db.VarChar(255)
  phone          String?        @db.VarChar(20)
  mobile         String?        @db.VarChar(20)
  birthDate      DateTime?      @map("birth_date") @db.Date
  zipCode        String?        @map("zip_code") @db.VarChar(10)
  address        String?        @db.VarChar(255)
  number         String?        @db.VarChar(20)
  complement     String?        @db.VarChar(100)
  neighborhood   String?        @db.VarChar(100)
  city           String?        @db.VarChar(100)
  state          String?        @db.VarChar(2)
  creditLimit    Decimal        @default(0) @map("credit_limit") @db.Decimal(10, 2)
  status         CustomerStatus @default(active)
  loyaltyPoints  Int            @default(0) @map("loyalty_points")
  totalSpent     Decimal        @default(0) @map("total_spent") @db.Decimal(10, 2)
  lastPurchaseAt DateTime?      @map("last_purchase_at")
  notes          String?        @db.Text
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  pets                  Pet[]
  sales                 Sale[]
  quotes                Quote[]
  loyaltyTransactions   LoyaltyTransaction[]
  financialTransactions FinancialTransaction[]

  @@index([cpfCnpj])
  @@index([phone])
  @@index([status])
  @@map("customers")
}

model Pet {
  id         String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customerId String     @map("customer_id") @db.Uuid
  name       String     @db.VarChar(100)
  species    String?    @db.VarChar(50)
  breed      String?    @db.VarChar(100)
  size       PetSize?
  gender     PetGender?
  birthDate  DateTime?  @map("birth_date") @db.Date
  photoUrl   String?    @map("photo_url") @db.Text
  notes      String?    @db.Text
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("pets")
}

model LoyaltyTransaction {
  id          String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customerId  String                 @map("customer_id") @db.Uuid
  type        LoyaltyTransactionType
  points      Int
  description String?                @db.Text
  referenceId String?                @map("reference_id") @db.Uuid
  expiresAt   DateTime?              @map("expires_at")
  createdAt   DateTime               @default(now()) @map("created_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("loyalty_transactions")
}

// =====================================================
// 3. FORNECEDORES
// =====================================================

model Supplier {
  id                      String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyName             String         @map("company_name") @db.VarChar(255)
  tradeName               String?        @map("trade_name") @db.VarChar(255)
  cnpj                    String         @unique @db.VarChar(18)
  email                   String?        @db.VarChar(255)
  phone                   String?        @db.VarChar(20)
  mobile                  String?        @db.VarChar(20)
  website                 String?        @db.VarChar(255)
  zipCode                 String?        @map("zip_code") @db.VarChar(10)
  address                 String?        @db.VarChar(255)
  number                  String?        @db.VarChar(20)
  complement              String?        @db.VarChar(100)
  neighborhood            String?        @db.VarChar(100)
  city                    String?        @db.VarChar(100)
  state                   String?        @db.VarChar(2)
  paymentTerms            String?        @map("payment_terms") @db.VarChar(100)
  discountForEarlyPayment Decimal?       @map("discount_for_early_payment") @db.Decimal(5, 2)
  averageDeliveryDays     Int?           @map("average_delivery_days")
  rating                  Decimal?       @db.Decimal(3, 2)
  status                  SupplierStatus @default(active)
  notes                   String?        @db.Text
  createdAt               DateTime       @default(now()) @map("created_at")
  updatedAt               DateTime       @updatedAt @map("updated_at")

  products              Product[]
  financialTransactions FinancialTransaction[]

  @@map("suppliers")
}

// =====================================================
// PARA CONTINUAR, COPIE A PARTE 3/4
// =====================================================
// =====================================================
// PRISMA SCHEMA - ERP PET SHOP - PARTE 3/4
// Produtos, Estoque, Vendas e PDV
// COPIE APÓS A PARTE 2
// =====================================================

// =====================================================
// 4. PRODUTOS E ESTOQUE
// =====================================================

model ProductCategory {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String    @db.VarChar(100)
  parentId    String?   @map("parent_id") @db.Uuid
  description String?   @db.Text
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  parent   ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children ProductCategory[] @relation("CategoryHierarchy")
  products Product[]

  @@map("product_categories")
}

model Product {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  categoryId       String?  @map("category_id") @db.Uuid
  supplierId       String?  @map("supplier_id") @db.Uuid
  name             String   @db.VarChar(255)
  description      String?  @db.Text
  brand            String?  @db.VarChar(100)
  internalCode     String?  @unique @map("internal_code") @db.VarChar(100)
  ean              String?  @db.VarChar(13)
  sku              String?  @db.VarChar(100)
  costPrice        Decimal  @default(0) @map("cost_price") @db.Decimal(10, 2)
  salePrice        Decimal  @default(0) @map("sale_price") @db.Decimal(10, 2)
  profitMargin     Decimal? @map("profit_margin") @db.Decimal(5, 2)
  stockQuantity    Decimal  @default(0) @map("stock_quantity") @db.Decimal(10, 3)
  minStock         Decimal  @default(0) @map("min_stock") @db.Decimal(10, 3)
  maxStock         Decimal? @map("max_stock") @db.Decimal(10, 3)
  unit             String   @default("UN") @db.VarChar(20)
  isBulk           Boolean  @default(false) @map("is_bulk")
  parentProductId  String?  @map("parent_product_id") @db.Uuid
  conversionFactor Decimal? @map("conversion_factor") @db.Decimal(10, 3)
  isPerishable     Boolean  @default(false) @map("is_perishable")
  shelfLifeDays    Int?     @map("shelf_life_days")
  trackByBatch     Boolean  @default(false) @map("track_by_batch")
  ncm              String?  @db.VarChar(8)
  cest             String?  @db.VarChar(7)
  cfop             String?  @default("5102") @db.VarChar(4)
  icmsRate         Decimal? @map("icms_rate") @db.Decimal(5, 2)
  ipiRate          Decimal? @map("ipi_rate") @db.Decimal(5, 2)
  pisRate          Decimal? @map("pis_rate") @db.Decimal(5, 2)
  cofinsRate       Decimal? @map("cofins_rate") @db.Decimal(5, 2)
  imageUrl         String?  @map("image_url") @db.Text
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  category       ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  supplier       Supplier?        @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  parentProduct  Product?         @relation("BulkProducts", fields: [parentProductId], references: [id], onDelete: SetNull)
  bulkProducts   Product[]        @relation("BulkProducts")
  productStock   ProductStock[]
  productBatches ProductBatch[]
  stockMovements StockMovement[]
  saleItems      SaleItem[]
  quoteItems     QuoteItem[]

  @@index([categoryId])
  @@index([ean])
  @@index([internalCode])
  @@index([isActive])
  @@index([isBulk])
  @@map("products")
}

model StockLocation {
  id        String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String             @unique @db.VarChar(100)
  type      StockLocationType?
  address   String?            @db.Text
  isDefault Boolean            @default(false) @map("is_default")
  isActive  Boolean            @default(true) @map("is_active")
  createdAt DateTime           @default(now()) @map("created_at")
  updatedAt DateTime           @updatedAt @map("updated_at")

  productStock   ProductStock[]
  productBatches ProductBatch[]
  stockMovements StockMovement[]
  pdvTerminals   PdvTerminal[]
  invoiceSeries  InvoiceSeries[]

  @@map("stock_locations")
}

model ProductStock {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId        String   @map("product_id") @db.Uuid
  locationId       String   @map("location_id") @db.Uuid
  quantity         Decimal  @default(0) @db.Decimal(10, 3)
  reservedQuantity Decimal  @default(0) @map("reserved_quantity") @db.Decimal(10, 3)
  updatedAt        DateTime @updatedAt @map("updated_at")

  product  Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  location StockLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([productId, locationId])
  @@index([productId])
  @@index([locationId])
  @@map("product_stock")
}

model ProductBatch {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId       String    @map("product_id") @db.Uuid
  batchNumber     String    @map("batch_number") @db.VarChar(100)
  manufactureDate DateTime? @map("manufacture_date") @db.Date
  expiryDate      DateTime? @map("expiry_date") @db.Date
  quantity        Decimal   @default(0) @db.Decimal(10, 3)
  locationId      String?   @map("location_id") @db.Uuid
  isBlocked       Boolean   @default(false) @map("is_blocked")
  notes           String?   @db.Text
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  product        Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  location       StockLocation?  @relation(fields: [locationId], references: [id], onDelete: SetNull)
  stockMovements StockMovement[]
  saleItems      SaleItem[]

  @@unique([productId, batchNumber])
  @@map("product_batches")
}

model StockMovement {
  id            String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId     String            @map("product_id") @db.Uuid
  batchId       String?           @map("batch_id") @db.Uuid
  locationId    String?           @map("location_id") @db.Uuid
  type          StockMovementType
  quantity      Decimal           @db.Decimal(10, 3)
  costPrice     Decimal?          @map("cost_price") @db.Decimal(10, 2)
  referenceType String?           @map("reference_type") @db.VarChar(50)
  referenceId   String?           @map("reference_id") @db.Uuid
  userId        String?           @map("user_id") @db.Uuid
  notes         String?           @db.Text
  createdAt     DateTime          @default(now()) @map("created_at")

  product  Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  batch    ProductBatch?  @relation(fields: [batchId], references: [id], onDelete: SetNull)
  location StockLocation? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  user     User?          @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([productId])
  @@index([createdAt])
  @@map("stock_movements")
}

// =====================================================
// 5. VENDAS E PDV
// =====================================================

model PdvTerminal {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String    @db.VarChar(100)
  locationId   String?   @map("location_id") @db.Uuid
  serialNumber String?   @map("serial_number") @db.VarChar(100)
  ipAddress    String?   @map("ip_address") @db.VarChar(45)
  isActive     Boolean   @default(true) @map("is_active")
  lastSyncAt   DateTime? @map("last_sync_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  location      StockLocation? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  sales         Sale[]
  cashRegisters CashRegister[]

  @@map("pdv_terminals")
}

model CashRegister {
  id              String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  terminalId      String             @map("terminal_id") @db.Uuid
  userId          String             @map("user_id") @db.Uuid
  openedAt        DateTime           @default(now()) @map("opened_at")
  closedAt        DateTime?          @map("closed_at")
  openingBalance  Decimal            @default(0) @map("opening_balance") @db.Decimal(10, 2)
  closingBalance  Decimal?           @map("closing_balance") @db.Decimal(10, 2)
  expectedBalance Decimal?           @map("expected_balance") @db.Decimal(10, 2)
  difference      Decimal?           @db.Decimal(10, 2)
  status          CashRegisterStatus @default(open)
  notes           String?            @db.Text
  createdAt       DateTime           @default(now()) @map("created_at")

  terminal      PdvTerminal     @relation(fields: [terminalId], references: [id], onDelete: Cascade)
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  sales         Sale[]
  cashMovements CashMovement[]

  @@map("cash_registers")
}

model CashMovement {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cashRegisterId String           @map("cash_register_id") @db.Uuid
  type           CashMovementType
  amount         Decimal          @db.Decimal(10, 2)
  reason         String?          @db.Text
  userId         String?          @map("user_id") @db.Uuid
  createdAt      DateTime         @default(now()) @map("created_at")

  cashRegister CashRegister @relation(fields: [cashRegisterId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("cash_movements")
}

model Sale {
  id                    String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  saleNumber            String       @unique @map("sale_number") @db.VarChar(50)
  terminalId            String?      @map("terminal_id") @db.Uuid
  cashRegisterId        String?      @map("cash_register_id") @db.Uuid
  customerId            String?      @map("customer_id") @db.Uuid
  userId                String       @map("user_id") @db.Uuid
  subtotal              Decimal      @default(0) @db.Decimal(10, 2)
  discount              Decimal      @default(0) @db.Decimal(10, 2)
  total                 Decimal      @default(0) @db.Decimal(10, 2)
  status                SaleStatus   @default(completed)
  cancelledReason       String?      @map("cancelled_reason") @db.Text
  cancelledBy           String?      @map("cancelled_by") @db.Uuid
  cancelledAt           DateTime?    @map("cancelled_at")
  invoiceType           InvoiceType? @map("invoice_type")
  invoiceNumber         String?      @map("invoice_number") @db.VarChar(50)
  invoiceSeries         String?      @map("invoice_series") @db.VarChar(10)
  invoiceKey            String?      @map("invoice_key") @db.VarChar(44)
  invoiceXmlPath        String?      @map("invoice_xml_path") @db.Text
  invoicePdfPath        String?      @map("invoice_pdf_path") @db.Text
  invoiceIssuedAt       DateTime?    @map("invoice_issued_at")
  synced                Boolean      @default(false)
  syncErrors            String?      @map("sync_errors") @db.Text
  loyaltyPointsEarned   Int          @default(0) @map("loyalty_points_earned")
  loyaltyPointsRedeemed Int          @default(0) @map("loyalty_points_redeemed")
  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @updatedAt @map("updated_at")

  terminal        PdvTerminal?  @relation(fields: [terminalId], references: [id], onDelete: SetNull)
  cashRegister    CashRegister? @relation(fields: [cashRegisterId], references: [id], onDelete: SetNull)
  customer        Customer?     @relation(fields: [customerId], references: [id], onDelete: SetNull)
  user            User          @relation(fields: [userId], references: [id], onDelete: SetNull)
  cancelledByUser User?         @relation("CancelledBy", fields: [cancelledBy], references: [id], onDelete: SetNull)
  saleItems       SaleItem[]
  salePayments    SalePayment[]
  invoices        Invoice[]
  quotes          Quote[]

  @@index([customerId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([synced])
  @@map("sales")
}

model SaleItem {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  saleId           String    @map("sale_id") @db.Uuid
  productId        String    @map("product_id") @db.Uuid
  batchId          String?   @map("batch_id") @db.Uuid
  quantity         Decimal   @db.Decimal(10, 3)
  unitPrice        Decimal   @map("unit_price") @db.Decimal(10, 2)
  costPrice        Decimal?  @map("cost_price") @db.Decimal(10, 2)
  discount         Decimal   @default(0) @db.Decimal(10, 2)
  total            Decimal   @db.Decimal(10, 2)
  weight           Decimal?  @db.Decimal(10, 3)
  barcodeGenerated String?   @map("barcode_generated") @db.VarChar(13)
  deletedAt        DateTime? @map("deleted_at")
  deletedBy        String?   @map("deleted_by") @db.Uuid
  deletionReason   String?   @map("deletion_reason") @db.Text
  createdAt        DateTime  @default(now()) @map("created_at")

  sale          Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  batch         ProductBatch? @relation(fields: [batchId], references: [id], onDelete: SetNull)
  deletedByUser User?         @relation("DeletedBy", fields: [deletedBy], references: [id], onDelete: SetNull)

  @@index([saleId])
  @@index([productId])
  @@map("sale_items")
}

model SalePayment {
  id                String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  saleId            String        @map("sale_id") @db.Uuid
  paymentMethod     PaymentMethod @map("payment_method")
  amount            Decimal       @db.Decimal(10, 2)
  cardBrand         String?       @map("card_brand") @db.VarChar(50)
  cardLastDigits    String?       @map("card_last_digits") @db.VarChar(4)
  installments      Int           @default(1)
  authorizationCode String?       @map("authorization_code") @db.VarChar(100)
  pixQrcode         String?       @map("pix_qrcode") @db.Text
  pixTxid           String?       @map("pix_txid") @db.VarChar(100)
  pixE2eid          String?       @map("pix_e2eid") @db.VarChar(100)
  pixStatus         PixStatus?    @map("pix_status")
  pixConfirmedAt    DateTime?     @map("pix_confirmed_at")
  changeAmount      Decimal?      @map("change_amount") @db.Decimal(10, 2)
  notes             String?       @db.Text
  createdAt         DateTime      @default(now()) @map("created_at")

  sale Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@map("sale_payments")
}

// =====================================================
// 6. ORÇAMENTOS
// =====================================================

model Quote {
  id                String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  quoteNumber       String      @unique @map("quote_number") @db.VarChar(50)
  customerId        String?     @map("customer_id") @db.Uuid
  userId            String      @map("user_id") @db.Uuid
  subtotal          Decimal     @default(0) @db.Decimal(10, 2)
  discount          Decimal     @default(0) @db.Decimal(10, 2)
  total             Decimal     @default(0) @db.Decimal(10, 2)
  validUntil        DateTime    @map("valid_until") @db.Date
  status            QuoteStatus @default(pending)
  convertedToSaleId String?     @unique @map("converted_to_sale_id") @db.Uuid
  convertedAt       DateTime?   @map("converted_at")
  notes             String?     @db.Text
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  customer        Customer?   @relation(fields: [customerId], references: [id], onDelete: SetNull)
  user            User        @relation(fields: [userId], references: [id], onDelete: SetNull)
  convertedToSale Sale?       @relation(fields: [convertedToSaleId], references: [id], onDelete: SetNull)
  quoteItems      QuoteItem[]

  @@map("quotes")
}

model QuoteItem {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  quoteId   String   @map("quote_id") @db.Uuid
  productId String   @map("product_id") @db.Uuid
  quantity  Decimal  @db.Decimal(10, 3)
  unitPrice Decimal  @map("unit_price") @db.Decimal(10, 2)
  discount  Decimal  @default(0) @db.Decimal(10, 2)
  total     Decimal  @db.Decimal(10, 2)
  notes     String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  quote   Quote   @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("quote_items")
}

// =====================================================
// PARA CONTINUAR, COPIE A PARTE 4/4
// =====================================================
// =====================================================
// PRISMA SCHEMA - ERP PET SHOP - PARTE 4/4 (FINAL)
// Financeiro, Fiscal e Configurações
// COPIE APÓS A PARTE 3
// =====================================================

// =====================================================
// 7. FINANCEIRO
// =====================================================

model ChartOfAccounts {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code         String      @unique @db.VarChar(20)
  name         String      @db.VarChar(255)
  type         AccountType
  parentId     String?     @map("parent_id") @db.Uuid
  isAnalytical Boolean     @default(true) @map("is_analytical")
  isActive     Boolean     @default(true) @map("is_active")
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  parent               ChartOfAccounts?       @relation("AccountHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children             ChartOfAccounts[]      @relation("AccountHierarchy")
  financialTransactions FinancialTransaction[]

  @@map("chart_of_accounts")
}

model CostCenter {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @unique @db.VarChar(100)
  description String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  financialTransactions FinancialTransaction[]

  @@map("cost_centers")
}

model BankAccount {
  id                 String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name               String          @db.VarChar(100)
  bankName           String          @map("bank_name") @db.VarChar(100)
  bankCode           String?         @map("bank_code") @db.VarChar(10)
  agency             String?         @db.VarChar(20)
  accountNumber      String?         @map("account_number") @db.VarChar(20)
  accountType        BankAccountType? @map("account_type")
  initialBalance     Decimal         @default(0) @map("initial_balance") @db.Decimal(10, 2)
  currentBalance     Decimal         @default(0) @map("current_balance") @db.Decimal(10, 2)
  pixEnabled         Boolean         @default(false) @map("pix_enabled")
  pixKey             String?         @map("pix_key") @db.VarChar(255)
  pixApiCredentials  Json?           @map("pix_api_credentials")
  isActive           Boolean         @default(true) @map("is_active")
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")

  financialTransactions FinancialTransaction[]
  bankReconciliations   BankReconciliation[]

  @@map("bank_accounts")
}

model FinancialTransaction {
  id                  String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type                TransactionType
  accountId           String            @map("account_id") @db.Uuid
  costCenterId        String?           @map("cost_center_id") @db.Uuid
  bankAccountId       String?           @map("bank_account_id") @db.Uuid
  customerId          String?           @map("customer_id") @db.Uuid
  supplierId          String?           @map("supplier_id") @db.Uuid
  description         String            @db.Text
  amount              Decimal           @db.Decimal(10, 2)
  issueDate           DateTime          @map("issue_date") @db.Date
  dueDate             DateTime          @map("due_date") @db.Date
  paidDate            DateTime?         @map("paid_date") @db.Date
  status              TransactionStatus @default(pending)
  paymentMethod       String?           @map("payment_method") @db.VarChar(50)
  installmentNumber   Int?              @map("installment_number")
  totalInstallments   Int?              @map("total_installments")
  parentTransactionId String?           @map("parent_transaction_id") @db.Uuid
  interest            Decimal           @default(0) @db.Decimal(10, 2)
  discount            Decimal           @default(0) @db.Decimal(10, 2)
  paidAmount          Decimal           @default(0) @map("paid_amount") @db.Decimal(10, 2)
  isRecurring         Boolean           @default(false) @map("is_recurring")
  recurrenceFrequency String?           @map("recurrence_frequency") @db.VarChar(20)
  documentType        String?           @map("document_type") @db.VarChar(50)
  documentNumber      String?           @map("document_number") @db.VarChar(100)
  attachmentPath      String?           @map("attachment_path") @db.Text
  referenceType       String?           @map("reference_type") @db.VarChar(50)
  referenceId         String?           @map("reference_id") @db.Uuid
  notes               String?           @db.Text
  userId              String?           @map("user_id") @db.Uuid
  createdAt           DateTime          @default(now()) @map("created_at")
  updatedAt           DateTime          @updatedAt @map("updated_at")

  account           ChartOfAccounts     @relation(fields: [accountId], references: [id], onDelete: Restrict)
  costCenter        CostCenter?         @relation(fields: [costCenterId], references: [id], onDelete: SetNull)
  bankAccount       BankAccount?        @relation(fields: [bankAccountId], references: [id], onDelete: SetNull)
  customer          Customer?           @relation(fields: [customerId], references: [id], onDelete: SetNull)
  supplier          Supplier?           @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  user              User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  parentTransaction FinancialTransaction? @relation("TransactionInstallments", fields: [parentTransactionId], references: [id], onDelete: Cascade)
  installments      FinancialTransaction[] @relation("TransactionInstallments")
  reconciliations   BankReconciliation[]

  @@index([accountId])
  @@index([type])
  @@index([status])
  @@index([dueDate])
  @@index([paidDate])
  @@index([customerId])
  @@index([supplierId])
  @@map("financial_transactions")
}

model BankReconciliation {
  id                  String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  bankAccountId       String                @map("bank_account_id") @db.Uuid
  transactionId       String?               @map("transaction_id") @db.Uuid
  bankTransactionDate DateTime              @map("bank_transaction_date") @db.Date
  bankDescription     String?               @map("bank_description") @db.Text
  bankAmount          Decimal               @map("bank_amount") @db.Decimal(10, 2)
  status              ReconciliationStatus  @default(pending)
  reconciledBy        String?               @map("reconciled_by") @db.Uuid
  reconciledAt        DateTime?             @map("reconciled_at")
  notes               String?               @db.Text
  createdAt           DateTime              @default(now()) @map("created_at")

  bankAccount BankAccount           @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  transaction FinancialTransaction? @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  user        User?                 @relation(fields: [reconciledBy], references: [id], onDelete: SetNull)

  @@map("bank_reconciliations")
}

// =====================================================
// 8. FISCAL
// =====================================================

model DigitalCertificate {
  id                String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String          @db.VarChar(255)
  type              CertificateType
  certificateFile   Bytes?          @map("certificate_file")
  passwordEncrypted String?         @map("password_encrypted") @db.VarChar(255)
  issuedBy          String?         @map("issued_by") @db.VarChar(255)
  validFrom         DateTime        @map("valid_from") @db.Date
  validUntil        DateTime        @map("valid_until") @db.Date
  isActive          Boolean         @default(true) @map("is_active")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  @@map("digital_certificates")
}

model InvoiceSeries {
  id         String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type       InvoiceType
  series     String     @db.VarChar(10)
  nextNumber Int        @default(1) @map("next_number")
  locationId String?    @map("location_id") @db.Uuid
  isActive   Boolean    @default(true) @map("is_active")
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")

  location StockLocation? @relation(fields: [locationId], references: [id], onDelete: SetNull)

  @@unique([type, series])
  @@map("invoice_series")
}

model Invoice {
  id                    String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type                  InvoiceType
  number                String        @db.VarChar(50)
  series                String        @db.VarChar(10)
  accessKey             String?       @map("access_key") @db.VarChar(44)
  status                InvoiceStatus @default(pending)
  issuerCnpj            String        @map("issuer_cnpj") @db.VarChar(18)
  issuerName            String        @map("issuer_name") @db.VarChar(255)
  recipientType         String?       @map("recipient_type") @db.VarChar(20)
  recipientId           String?       @map("recipient_id") @db.Uuid
  recipientCpfCnpj      String?       @map("recipient_cpf_cnpj") @db.VarChar(18)
  recipientName         String?       @map("recipient_name") @db.VarChar(255)
  subtotal              Decimal       @db.Decimal(10, 2)
  discount              Decimal       @default(0) @db.Decimal(10, 2)
  total                 Decimal       @db.Decimal(10, 2)
  icmsTotal             Decimal       @default(0) @map("icms_total") @db.Decimal(10, 2)
  ipiTotal              Decimal       @default(0) @map("ipi_total") @db.Decimal(10, 2)
  authorizationProtocol String?       @map("authorization_protocol") @db.VarChar(50)
  authorizationDate     DateTime?     @map("authorization_date")
  sefazResponse         String?       @map("sefaz_response") @db.Text
  cancelledAt           DateTime?     @map("cancelled_at")
  cancellationProtocol  String?       @map("cancellation_protocol") @db.VarChar(50)
  cancellationReason    String?       @map("cancellation_reason") @db.Text
  xmlFile               Bytes?        @map("xml_file")
  pdfPath               String?       @map("pdf_path") @db.Text
  saleId                String?       @map("sale_id") @db.Uuid
  notes                 String?       @db.Text
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")

  sale Sale? @relation(fields: [saleId], references: [id], onDelete: SetNull)

  @@index([accessKey])
  @@index([status])
  @@index([saleId])
  @@map("invoices")
}

// =====================================================
// 9. CONFIGURAÇÕES
// =====================================================

model CompanySettings {
  id                     String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyName            String   @map("company_name") @db.VarChar(255)
  tradeName              String?  @map("trade_name") @db.VarChar(255)
  cnpj                   String   @unique @db.VarChar(18)
  stateRegistration      String?  @map("state_registration") @db.VarChar(50)
  municipalRegistration  String?  @map("municipal_registration") @db.VarChar(50)
  taxRegime              String?  @map("tax_regime") @db.VarChar(50)
  zipCode                String?  @map("zip_code") @db.VarChar(10)
  address                String?  @db.VarChar(255)
  number                 String?  @db.VarChar(20)
  complement             String?  @db.VarChar(100)
  neighborhood           String?  @db.VarChar(100)
  city                   String?  @db.VarChar(100)
  state                  String?  @db.VarChar(2)
  phone                  String?  @db.VarChar(20)
  email                  String?  @db.VarChar(255)
  website                String?  @db.VarChar(255)
  logoUrl                String?  @map("logo_url") @db.Text
  nfceSeries             String?  @map("nfce_series") @db.VarChar(10)
  nfeSeries              String?  @map("nfe_series") @db.VarChar(10)
  nfseRpsSeries          String?  @map("nfse_rps_series") @db.VarChar(10)
  loyaltyEnabled         Boolean  @default(false) @map("loyalty_enabled")
  loyaltyPointsPerReal   Decimal  @default(1) @map("loyalty_points_per_real") @db.Decimal(5, 2)
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  @@map("company_settings")
}

model SystemSettings {
  key         String   @id @db.VarChar(100)
  value       Json
  description String?  @db.Text
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

// =====================================================
// FIM DO SCHEMA PRISMA
// =====================================================

// Notas de Uso:
// 1. Execute: npx prisma generate
// 2. Execute: npx prisma db push (desenvolvimento) ou npx prisma migrate dev (produção)
// 3. Para seed inicial: npx prisma db seed
// 4. Para Prisma Studio: npx prisma studio
